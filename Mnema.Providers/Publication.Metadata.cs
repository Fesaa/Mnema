using System.IO;
using System.Threading.Tasks;
using System.Xml.Serialization;
using Microsoft.Extensions.DependencyInjection;
using Mnema.API.Content;
using Mnema.Common.Helpers;
using Mnema.Models.External;
using Mnema.Models.Publication;

namespace Mnema.Providers;

internal partial class Publication
{
    private const string ComicInfoNote =
        "This comicinfo.xml was auto generated by Mnema, with information from {0}. Source code can be found here: https://github.com/Fesaa/Mnema/";
    private static readonly XmlSerializer XmlSerializer = new(typeof(ComicInfo));

    private readonly IMetadataService _metadataService = scope.ServiceProvider.GetRequiredService<IMetadataService>();

    private bool _hasNotifiedSubscriptionExhausted;

    private async Task WriteMetadataForChapter(Chapter chapter)
    {
        var coverUrl = string.IsNullOrEmpty(chapter.CoverUrl) ? Series!.CoverUrl : chapter.CoverUrl;

        if (Request.GetBool(RequestConstants.IncludeCover, true))
            if (!string.IsNullOrEmpty(coverUrl))
            {
                var filePath = Path.Join(ChapterPath(chapter), $"!0000 cover{_fileSystem.Path.GetExtension(coverUrl)}");
                var client = _httpClientFactory.CreateClient(provider.ToString());

                await using var stream = await client.GetStreamAsync(coverUrl);
                await using var file = _fileSystem.File.Create(filePath);
                await stream.CopyToAsync(file);
            }

        var ci = _metadataService.CreateComicInfo(Preferences, Request, Title, Series, chapter, string.Format(ComicInfoNote, provider.ToString()));
        if (ci != null)
        {
            if (ci.Finished && !_hasNotifiedSubscriptionExhausted)
            {
                _hasNotifiedSubscriptionExhausted = true;
                _connectionService.CommunicateSubscriptionExhausted(DownloadInfo);
            }

            var ciPath = Path.Join(ChapterPath(chapter), "ComicInfo.xml");
            XmlHelper.SerializeToFile(XmlSerializer, ci, ciPath);
        }
    }
}
